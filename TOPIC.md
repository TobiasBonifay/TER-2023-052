# Limiting Memory Reclaiming Impact on VMs Performance

**Tobias Bonifay**, IT science student at Polytech Nice Sophia, graduate 2024.  
Specialized in software engineering and networking.

## Introduction
Virtualization is the main building block in current Data Centers. By deploying multiple virtual machines (VMs), virtualization optimizes the utilization of physical resources in servers with large capacities. Sharing some resources like Network Interface Cards (NICs) or CPU between multiple virtual instances does not create major problems. 

E.g. one single core can easily be shared between several VMs as servers usually run between 5-10% of CPU utilization and NICs frequently feature multiple ports with bandwidth larger than 1Gbps per port. However, sharing the memory is a challenging task. Indeed, sharing one single region of memory between several VMs will need the execution of eviction-like solutions to replace the memory content from one VM with the data generated by another one. Then store somewhere else the evicted data. Hence, a region of memory is frequently only assigned to one single VM. Since most Operating Systems need at least 1GB of memory, and due to the large numbers of VMs that need to be deployed, memory is a scarce resource in Data Centers.

## Memory reclaiming techniques
To optimize the memory utilization, VMs can be smartly placed to minimize the portion of unassigned memory in servers, e.g. a server with 4GB of free memory could never be used if the VMs to be deployed would need 8GB at least. To reduce the VM’s memory footprint, ballooning and/or swapping can be employed to reclaim the memory VM [1]. In ballooning, the guest inflates a “balloon” to lock some memory at the VM which is then made available to the host (i.e. the hypervisor) [7]. 

Swapping is another technique to reclaim VM’s memory, where the hypervisor shrinks the allocated memory to the VM, hence swapping-out the memory of the VMs beyond a given limit. VMware also implemented a Transparent Page Sharing solution [1], where VMs memory pages with the same content are shared across multiple VMs (a.k.a. page deduplication [6,8]). In the SigNet team, we proposed a solution mixing ballooning and a technique to detect the active memory pages of a VM (a.k.a. the working set) and then swapping out the inactive memory regions [3]. In [2], the authors propose to reclaim clean file-backed pages to enable memory-overbooking.

## Impact of memory reclaiming techniques on the system performance
According to the preliminary work done in our team, after memory is effectively reclaimed by the hypervisor, wherever the amount of reclaimed memory is smaller or not to the free memory seen by the VM, there are some probabilities that the performance of the VM is degraded, leading to longer services completion times. Without intrusive techniques, forecasting the negative impact of the memory reduction at the VM is a complex task. 

Indeed, it depends on (i) the activity level of the VM and (ii) if the portion of reclaimed memory contains active pages or not. However, some parameters measuring the activity level of the VM can be accessed without intrusive techniques (e.g. CPU and bandwidth utilization, just to mention a couple of parameters), which give indirect insights and allow to determine if the portion of reclaimed memory contains active pages or not. 

Thus, in this case, the decision of how much and when memory is reclaimed constitutes a stochastic control problem, that can be modelled as Markov Decision Process (MDP) and solved under the Reinforcement Learning (RL) [4] or the Imitation Learning (IL) framework [5] (forms of Machine Learning). These RL/IL frameworks will allow us to learn the optimal control policies of memory reclaiming, i.e., depending on the VM activity level, to decide how much memory should be reclaimed and at which moment, aiming to minimize the negative impact onto the VM performance.

## Project objectives

### Background
At the SIGNET team, we are currently developing a solution to reclaim the unused VM memory without degrading the Quality of Service perceived by the user, without the need to deploy at the VMs or clients heavy and intrusive software. Thus, a first piece of code exists, which needs however to be improved and analyze its performance.

### Expected Responsibilities
More specifically, the student is expected to:

- Keep updating the state of the art on the different memory reclaim techniques proposed in the scientific literature and what is currently supported by the main Hypervisors (KVM, VMware, etc.)
- Test/implement in a KVM hypervisor both the memory reclaim solutions and Working Set estimations heuristics. Our solution that mixes ballooning and working set detection will be provided to the student.

### Impact Study
- Study the impact of memory reclaim on the network applications (Web servers, in memory data bases, data streaming applications), from the networking point of view:
  - Impact on the request/reply rates of a given application
  - Impact on the delay and jitter of the traffic
  - Propose a metric to quantify the impact of memory reclaiming on the system performance

### Architectural Solutions
- Architecture a smart solution to:
  - Forecast the impact of the VM memory reduction by only monitoring some system parameters (avoiding the need of intrusive software inside the VMs)
  - Decrease the VMs memory, while limiting the negative impact on the system performance
  
### RL/IL Approach
- Develop a RL/IL approach to find optimal control policies for reclaiming the memory:
  - Model the control problem as Markov Decision Process.
  - Solve the problem using the IL/RL algorithms.

## Pre-requisites
Good background in system administration, programming, networking. Hypervisor administration (especially KVM) is a plus.



## References
1. [“Understanding Memory Resource Management in VMware® ESX™ Server”](https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/perf-vsphere-memory_management.pdf)
2. Maxime Lorrillere, Julien Sopena, Sébastien Monnet, and Pierre Sens. 2015. [Puma: pooling unused memory in virtual machines for I/O intensive applications](https://doi.org/10.1145/2757667.2757669). In Proceedings of the 8th ACM International Systems and Storage Conference (SYSTOR '15). Association for Computing Machinery, New York, NY, USA, Article 1, 1–11.
3. D. Lopez Pacheco, Q. Jacquemart, A. Segalini, M. Rifai, M. Dione, and G. Urvoy-Keller. 2017. [SEaMLESS: a SErvice migration cLoud architecture for energy saving and memory releaSing capabilities](https://doi.org/10.1145/3127479.3128604). In Proceedings of the 2017 Symposium on Cloud Computing (SoCC '17). Association for Computing Machinery, New York, NY, USA, 645.
4. Lil Log, [Reinforcement Learning:](https://lilianweng.github.io/lil-log/2018/02/19/a-long-peek-into-reinforcement-learning.html)
5. [A Brief Overview of Imitation Learning](https://smartlabai.medium.com/a-brief-overview-of-imitation-learning-8a8a75c44a9c)
6. Diwaker Gupta, Sangmin Lee, Michael Vrable, Stefan Savage, Alex C. Snoeren, George Varghese, Geoffrey M. Voelker, and Amin Vahdat. 2010. [Difference engine: harnessing memory redundancy in virtual machines](https://doi.org/10.1145/1831407.1831429). Commun. ACM 53, 10 (October 2010), 85–93.
7. Chiang, Jui-Hao, Han-Lin Li and Tzi-cker Chiueh. 2013. [Working Set-based Physical Memory Ballooning.](#) ICAC.
8. Sean Barker, Timothy Wood, Prashant Shenoy, and Ramesh Sitaraman. 2012. [An empirical study of memory sharing in virtual machines](#). In Proceedings of the 2012 USENIX conference on Annual Technical Conference (USENIX ATC'12). USENIX Association, USA, 25.

**Supervisor**: Dino Lopez Pacheco  
**Co-Supervisor**: Ramon Aparicio Pardo
